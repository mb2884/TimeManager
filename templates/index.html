<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Time Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src='static/fullcalendar/dist/index.global.js'></script>
  <script src='static/app.js'></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <link href='static/style.css' rel='stylesheet' />
  <script>

    document.addEventListener('DOMContentLoaded', function () {
      var calendarEl = document.getElementById('calendar');

      var calendar = new FullCalendar.Calendar(calendarEl, {
        // Calendar configuration options
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        initialDate: '2024-04-02',
        timeZone: 'UTC',
        navLinks: true,
        selectable: true,
        selectMirror: true,
        eventClick: function (arg) {
          if (confirm('Are you sure you want to delete this event?')) {
            // Send an AJAX request to delete the event from the database
            $.ajax({
              type: 'POST',
              url: '/delete-event',
              contentType: 'application/json',
              data: JSON.stringify({ event_id: arg.event._def.publicId }), // Pass the event ID to the server
              success: function (response) {
                console.log(response); // Log success message
                arg.event.remove(); // Remove the event from the calendar UI
                refreshCalendar(); // Refresh the calendar after deleting the event
              },
              error: function (xhr, status, error) {
                console.error(error); // Log error message
                // Handle errors and provide feedback to the user
              }
            });
          }
        },
        editable: true,
        dayMaxEvents: true,
        select: function (arg) {
          var title = prompt('Event Title:');
          if (title) {
            let requestData = {
              type: 'POST',
              url: '/add-event',
              contentType: 'application/json',
              data: JSON.stringify({
                username: '{{username}}',
                title: title,
                start: arg.start.toISOString(),
                end: arg.end.toISOString(),
                allDay: arg.allDay,
                color: "007bff"
              }),
              success: function (response) {
                if (response.id) {
                  calendar.addEvent({
                    title: title,
                    start: arg.start,
                    end: arg.end,
                    allDay: arg.allDay,
                    id: response.id,
                    color: response.color
                  });
                  refreshCalendar(); // Refresh the calendar after adding the event
                }

              },
              error: function (xhr, status, error) {
                alert('There was an error processing your request. Please try again.');
                console.error(error);
              }
            };
            $.ajax(requestData);
          }
          calendar.unselect();
        },
        eventDrop: function (arg) {
          // When an event is dropped/moved, send an AJAX request to update the event on the server
          $.ajax({
            type: 'POST',
            url: '/update-event',
            contentType: 'application/json',
            data: JSON.stringify({
              event_id: arg.event._def.publicId,
              start: arg.event.start.toISOString(),
              end: arg.event.end ? arg.event.end.toISOString() : null, // Check if the event has an end time
              allDay: arg.event.allDay,
              title: arg.event.title
            }),
            success: function (response) {
              console.log(response); // Log success message
            },
            error: function (xhr, status, error) {
              console.error(error); // Log error message
              // Handle errors and provide feedback to the user
            }
          });
        },
        eventResize: function (arg) {
          // When an event is resized, send an AJAX request to update the event duration on the server
          $.ajax({
            type: 'POST',
            url: '/update-event',
            contentType: 'application/json',
            data: JSON.stringify({
              event_id: arg.event._def.publicId,
              start: arg.event.start.toISOString(),
              end: arg.event.end ? arg.event.end.toISOString() : null, // Check if the event has an end time
              allDay: arg.event.allDay,
              title: arg.event.title
            }),
            success: function (response) {
              console.log(response); // Log success message
            },
            error: function (xhr, status, error) {
              console.error(error); // Log error message
              // Handle errors and provide feedback to the user
            }
          });
        }
      });

      calendar.render();

      // Get events from the server
      $.ajax({
        type: 'GET',
        url: '/get-events',
        success: function (response) {
          // Add events to the calendar
          calendar.addEventSource(response);
        },
        error: function (xhr, status, error) {
          console.error(error);
          // Handle errors and provide feedback to the user
        }
      });

      setInterval(refreshCalendar, 1000);

      // Define refreshCalendar function
      function refreshCalendar() {
        // Get events from the server
        $.ajax({
          type: 'GET',
          url: '/get-events',
          success: function (events) {
            // Clear the calendar
            calendar.removeAllEvents();
            // Add events to the calendar
            calendar.addEventSource(events);
            calendar.render();
          },
          error: function (xhr, status, error) {
            console.error(error);
            // Handle errors and provide feedback to the user
          }
        });
      };

      // Function to validate all task fields
      function validateTaskFields() {
        var title = $('#taskName').val();
        var duration = parseInt($('#duration').val());
        var startDate = $('#startDate').val();
        var startTime = $('#startTime').val();
        var dueDate = $('#dueDate').val();
        var dueTime = $('#dueTime').val();


        if (isNaN(duration) || duration <= 0) {
          $('#durationError').text('Duration must be a positive number.');
          return false;
        }

        // Check if any field is empty
        if (title.trim() === '' || isNaN(duration) || duration <= 0 || startDate === '' || startTime === '' || dueDate === '' || dueTime === '') {
          $('#durationError').text('Please fill out all fields.');
          return false;
        }

        // Check if due date is after start date
        var startDateTime = new Date(startDate + ' ' + startTime);
        var endDateTime = new Date(dueDate + ' ' + dueTime);
        if (endDateTime <= startDateTime) {
          $('#durationError').text('Due date must be after start date.');
          return false;
        }

        $('#durationError').text('');
        return true;
      }

      // Function to add task
      function addTask() {
        // Validate all task fields
        if (!validateTaskFields()) {
          return; // Exit if validation fails
        }

        let title = $('#taskName').val();
        let duration = Math.round(parseFloat($('#duration').val()));
        let startDate = $('#startDate').val();
        let startTime = $('#startTime').val();
        let dueDate = $('#dueDate').val();
        let dueTime = $('#dueTime').val();

        let startDateTime = new Date(startDate + ' ' + startTime); // Combine start date and time
        let endDateTime = new Date(dueDate + ' ' + dueTime); // Combine due date and time

        // Send task details to the server
        $.ajax({
          type: 'POST',
          url: '/add-task',
          contentType: 'application/json',
          data: JSON.stringify({
            username: '{{username}}',
            title: title,
            start: startDateTime,
            end: endDateTime,
            length: duration // Include task-specific field
          }),
          success: function (response) {
            // Handle success response if needed
            console.log('Task added successfully:', response);
            // Refresh the calendar or any other action you need
            // Update the task list with the newly added task
            $('#taskList').append('<li>' + title + '<a href="#" class="delete-task" data-id="' + response.id + '">❌</a></li>');

            fetchAndDisplayTasks();
          },
          error: function (xhr, status, error) {
            // Handle error response if needed
            console.error('Error adding task:', error);
          }
        });

        // Clear the input fields
        //$('#taskName').val('');
        //$('#duration').val('');
        //$('#startDate').val('');
        //$('#startTime').val('');
        //$('#dueDate').val('');
        //$('#dueTime').val('');
      }

      // Event listener for add task button click
      $('#addTaskButton').click(function () {
        // Validate all fields before adding task
        if (validateTaskFields()) {
          addTask();
          // After adding the task, fetch and display tasks again
          fetchAndDisplayTasks();
        }
      });

      // Function to fetch tasks from the server and display them in the task list
      function fetchAndDisplayTasks() {
        // Fetch tasks from the server
        $.ajax({
          type: 'GET',
          url: '/get-tasks',
          success: function (tasks) {
            // Clear the task list
            $('#taskList').empty();

            // Iterate over each task and create a list item for it
            tasks.forEach(function (task) {
              // Create list item HTML
              var listItemHtml = '<li>' + task.title + '<a href="#" class="delete-task" data-id="' + task.id + '">❌</a></li>';

              // Append the list item to the task list
              $('#taskList').append(listItemHtml);
            });
          },
          error: function (xhr, status, error) {
            console.error(error);
            // Handle errors and provide feedback to the user
          }
        });
      }
      // On page load, fetch and display tasks
      fetchAndDisplayTasks();

      // Check if the tutorial has been completed before
      var tutorialCompleted = localStorage.getItem('tutorialCompleted');

      // If the tutorial has been completed before, hide it and return
      if (tutorialCompleted === 'true') {
        document.getElementById('tutorial').style.display = 'none';
      } else {
        // Show the tutorial
        document.getElementById('tutorial').style.display = 'block';
      }

      // Tutorial steps
      var steps = document.querySelectorAll(".tutorial-step");
      var currentStepIndex = 0;

      // Function to show a specific step
      function showStep(index) {
        steps.forEach(function (step, i) {
          step.style.display = i === index ? "block" : "none";
        });
      }

      // Show the first step initially
      showStep(currentStepIndex);

      // Add event listener for the Enter key to advance the tutorial steps
      document.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
          currentStepIndex++;
          if (currentStepIndex < steps.length) {
            showStep(currentStepIndex);
          } else {
            // If there are no more steps, hide the tutorial and mark it as completed
            document.getElementById("tutorial").style.display = "none";
            localStorage.setItem("tutorialCompleted", "true");
          }
        }
      });
    });



    $(document).on('click', '.delete-task', function () {
      var taskId = $(this).data('id');
      console.log('Deleting task with ID:', taskId);
      var listItem = $(this).closest('li'); // Get the parent <li> element

      // Send an AJAX request to delete the task from the server
      $.ajax({
        type: 'POST',
        url: '/delete-task',
        contentType: 'application/json',
        data: JSON.stringify({ task_id: taskId }), // Pass the task ID to the server
        success: function (response) {
          console.log(response); // Log success message
          // Remove the task from the task list
          listItem.remove(); // Remove the parent <li> element
        },
        error: function (xhr, status, error) {
          console.error(error); // Log error message
          // Handle errors and provide feedback to the user
        }
      });
    });

    // Define getRandomColor function
    function getRandomColor() {
      var minBrightness = 128; // Minimum brightness threshold

      // Generate random values for red, green, and blue components
      var r = Math.floor(Math.random() * 256);
      var g = Math.floor(Math.random() * 256);
      var b = Math.floor(Math.random() * 256);

      // Calculate the brightness of the color using the YIQ formula
      var brightness = (r * 299 + g * 587 + b * 114) / 1000;

      // If the brightness is below the threshold, adjust the color
      if (brightness < minBrightness) {
        // Increase brightness by adding a fixed value to each component
        var brightnessDifference = minBrightness - brightness;
        var adjustmentFactor = brightnessDifference / brightness;
        r = Math.min(255, Math.floor(r + adjustmentFactor * r));
        g = Math.min(255, Math.floor(g + adjustmentFactor * g));
        b = Math.min(255, Math.floor(b + adjustmentFactor * b));
      }

      // Convert RGB components to hexadecimal string representation
      var hexColor = '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);

      return hexColor;
    }

    document.addEventListener("DOMContentLoaded", function () {
      var phrases = [
        "You got this",
        "You're awesome",
        "Believe in yourself",
        "Stay positive",
        "Keep going",
        "Dream big",
        "Make it happen",
        "You're amazing",
        "You can do it",
        "Never give up",
        "Almost Friday",
        "Work hard play hard",
        "Grades are a social construct",
        "We out here",
        "So back",
        "Academic weapon",
        "Just rip it",
        "F it we ball",
        "Here we go",
        "You're so up right now",
        "Keep going!",
        "Don't forget to rest!"
      ];

      var index = 0;
      var dynamicText = document.getElementById("dynamicText");

      function updateText() {
        var phrase = phrases[index];
        var words = phrase.split(' '); // Split the phrase into words

        dynamicText.textContent = ''; // Clear the text content initially

        // Apply the random color to the text element
        dynamicText.style.color = getRandomColor();

        // Display each word sequentially with a delay
        words.forEach(function (word, wordIndex) {
          setTimeout(function () {
            dynamicText.textContent += word + ' '; // Append the word with a space
            // If it's the last word, append a newline character
            if (wordIndex === words.length - 1) {
              dynamicText.textContent += '\n';
            }
          }, wordIndex * 500); // Delay each word by 500 milliseconds
        });

        index = (index + 1) % phrases.length;
      }

      // Initial text update
      updateText();

      // Update text every 3 seconds
      setInterval(updateText, 3000);
    });

    function logout() {
      // Call the logout route when the button is clicked
      $.ajax({
        type: 'GET',
        url: '/logoutapp',
        success: function (response) {
          console.log(response); // success message
          window.location.href = '/landing'; // Redirect to the landing page
        },
        error: function (xhr, status, error) {
          console.error(error); // Log error message
        }
      });
    }

  </script>
</head>

<body>
  <div id='calendar'></div>

  <div class="sidebarleft">
    <h2> Hello, {{username}} </h2>
    <h2>Add Task</h2>
    <label for="taskName">Task Name:</label>
    <input class="input" type="text" id="taskName" name="taskName" placeholder="Enter task name">

    <label for="duration">Duration (hours):</label>
    <input class="input" type="number" id="duration" name="duration" placeholder="Enter duration" min="1">
    <br>

    <label for="startDate">When to start:</label>
    <input class="input" type="date" id="startDate" name="startDate">
    <input class="input" type="time" id="startTime" name="startTime">
    <br>

    <label for="dueDate">When Due:</label>
    <input class="input" type="date" id="dueDate" name="dueDate">
    <input class="input" type="time" id="dueTime" name="dueTime">

    <button id="addTaskButton">Add Task</button> <!-- Removed onclick attribute -->
    <br><br>
    <span id="durationError" style="color: red;"></span> <!-- Display error message here -->

    <h2>Tasks</h2>
    <ul id="taskList"></ul>
  </div>
  <div class="sidebarright">
    <div class="tutorial-container" id="tutorial">
      <div class="tutorial-step" id="step1">
          <p>Welcome to your Task Manager! Press Enter to go through the tutorial.</p>
      </div>
      <div class="tutorial-step" id="step2">
          <p>Toggle your calendar view with the Month/Week/Day options.</p>
      </div>
      <div class="tutorial-step" id="step3">
          <p>Click on any day in the calendar to add an event to block out your schedule.</p>
      </div>
      <div class="tutorial-step" id="step4">
          <p>You can also hold and drag in the Day view to add events at specific times.</p>
      </div>
      <div class="tutorial-step" id="step5">
          <p>Add your custom tasks in the left sidebar; you can see the tasks you added below the Add Task button.</p>
      </div>
      <div class="tutorial-step" id="step6">
          <p>After adding tasks and events, you can click and drag them to move them around. To delete events, you can click on them in the calendar, and to delete tasks, you can click on the red X icon in the Tasks sidebar. Happy managing!</p>
      </div>
    </div>
    <h2 id="dynamicText"> Loading...</h2>
  </div>
  <button onclick="logout()" id="logoutButton" style="position: absolute; top: 10px; right: 10px;">Logout</button>
</body>

</html>
